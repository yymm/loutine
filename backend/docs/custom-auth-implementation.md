# 簡易認証機構の実装

**実装日**: 2026-02-18  
**更新日**: 2026-02-19  
**目的**: dev環境へのデプロイ時にAPIを保護する簡易的な認証機構

## 実装内容

### 1. 認証ミドルウェア

`src/middleware/auth.ts`を新規作成し、`X-Custom-Auth-Key`ヘッダーを検証するミドルウェアを実装。

**機能:**
- `X-Custom-Auth-Key`ヘッダーの存在を確認
- 環境変数`CUSTOM_AUTH_KEY`と照合
- **環境変数が未設定の場合は500エラーを返却（fail-closed）**
- 認証失敗時は401または403エラーを返却

### 2. 適用範囲

`src/index.ts`で全てのAPIエンドポイント（`/api/*`）に適用。

### 3. 環境変数設定

**ローカル開発**: `wrangler.toml`と`wrangler.dev.toml`にデフォルトキーを設定

**dev環境**: Cloudflare Dashboardで本番用のキーに上書き

**重要**: デフォルトキーは開発用です。本番環境では必ず変更してください。

## セキュリティ改善（v2: 2026-02-19）

### fail-closed方式に変更

- ❌ **旧方式（fail-open）**: 環境変数未設定 → 認証スキップ → **dev環境で設定ミス = 危険**
- ✅ **新方式（fail-closed）**: 環境変数未設定 → 500エラー → **設定ミス = 即座に検出**

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-18 | 初版作成、簡易認証機構実装 |
| 2026-02-18 | 環境ベースの認証制御に変更、mobile_ui対応、runnテスト対応 |
| 2026-02-18 | Copilot PR review対応（YAML構造修正、エラーレスポンス統一） |
| 2026-02-19 | fail-closed方式に変更（セキュリティ強化） |
